"use strict";(()=>{var e={};e.id=1356,e.ids=[1356],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},79893:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>_,patchFetch:()=>g,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>v});var a={};t.r(a),t.d(a,{GET:()=>d,PUT:()=>p});var i=t(95419),n=t(69108),s=t(99678),o=t(78070),c=t(23917),l=t(66211),u=t(65256);async function d(e){try{let e=await (0,l.mk)(),r=e.user.clinicId,t=(0,c.v)(r),a=await t.raw.user.findUnique({where:{id:e.user.id},select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,role:!0}});if(!a)return o.default.json({error:"User not found"},{status:404});return o.default.json(a)}catch(e){return console.error("Error fetching user:",e),o.default.json({error:"Internal server error"},{status:500})}}async function p(e){try{let r=await (0,l.mk)(),t=r.user.clinicId,a=(0,c.v)(t),i=await e.json(),n=u.Ry({firstName:u.Z_().min(1,"First name is required"),lastName:u.Z_().min(1,"Last name is required"),phone:u.Z_().optional().nullable(),currentPassword:u.Z_().optional(),newPassword:u.Z_().optional()}).safeParse(i);if(!n.success)return o.default.json({error:"Validation failed",details:n.error.format()},{status:400});let{currentPassword:s,newPassword:d,...p}=n.data,w={...p};if(s&&d){if(!await a.raw.user.findUnique({where:{id:r.user.id},select:{password:!0}}))return o.default.json({error:"User not found"},{status:404})}else if(s&&!d||!s&&d)return o.default.json({error:"Both current and new password are required to change password"},{status:400});let f=await a.raw.user.update({where:{id:r.user.id},data:w,select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,role:!0}});return o.default.json(f)}catch(e){return console.error("Error updating user:",e),o.default.json({error:"Internal server error"},{status:500})}}let w=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/user/route",pathname:"/api/user",filename:"route",bundlePath:"app/api/user/route"},resolvedPagePath:"/home/hazem/Downloads/files (2)/medflow-saas-complete/medflow-saas/src/app/api/user/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:y,staticGenerationBailout:v}=w,_="/api/user/route";function g(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},81147:(e,r,t)=>{t.d(r,{HT:()=>w,I8:()=>u,a4:()=>f});var a=t(78554),i=t(65822),n=t(53524),s=t(3133),o=t(6521);let c=new n.PrismaClient,{handlers:l,auth:u,signIn:d,signOut:p}=(0,a.ZP)({adapter:(0,i.N)(c),session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET||"your-secret-key",debug:!1,trustHost:!0,pages:{signIn:"/auth/login",error:"/auth/login"},callbacks:{session:async({session:e,token:r})=>(e.user&&(e.user.id=r.sub,e.user.role=r.role,e.user.clinicId=r.clinicId,e.user.clinicName=r.clinicName),e),jwt:async({token:e,user:r})=>(r&&(e.role=r.role,e.clinicId=r.clinicId,e.clinicName=r.clinicName),e)},providers:[(0,s.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=await c.user.findUnique({where:{email:e.email},include:{clinic:!0}});if(!r||!r.password||!await (0,o.compare)(e.password,r.password))return null;return{id:r.id,email:r.email,name:[r.firstName,r.lastName].filter(Boolean).join(" ")||r.email.split("@")[0],role:r.role,clinicId:r.clinicId,clinicName:r.clinic?.name||void 0}}catch(e){return console.error("Authentication error:",e),null}}})]}),{GET:w,POST:f}=l},66211:(e,r,t)=>{t.d(r,{MH:()=>l,j7:()=>c,mk:()=>o,t0:()=>s});var a=t(78070),i=t(81147),n=t(14307);async function s(){try{return await (0,i.I8)()}catch(e){return null}}async function o(){let e=await s();if(!e?.user)throw new a.default(JSON.stringify({error:"Unauthorized"}),{status:401});try{await (0,n.Q)(e.user.clinicId)}catch(e){console.warn("setCurrentClinic failed",e)}return e}async function c(e){let r=(await o()).user.clinicId;return(0,n.I)(r,e)}async function l(e=[]){let r=await o(),t=r.user.role;if(!e.includes(t))throw new a.default(JSON.stringify({error:"Forbidden"}),{status:403});return r}},14307:(e,r,t)=>{t.d(r,{I:()=>n,Q:()=>i});var a=t(34490);async function i(e){if(e)try{await a._.$executeRawUnsafe(`select set_config('medflow.current_clinic', '${e}', true);`)}catch(e){console.warn("Failed to set DB session clinic id for RLS:",e)}}async function n(e,r){if(!e)throw Error("clinicId required for runWithClinicTransaction");return a._.$transaction(async t=>{try{await t.$executeRawUnsafe(`select set_config('medflow.current_clinic', '${e}', true);`)}catch(e){console.warn("Failed to set session clinic in transaction",e)}return r(t)})}},23917:(e,r,t)=>{t.d(r,{v:()=>i});var a=t(34490);function i(e){if(!e)throw Error("clinicId is required for scoped prisma");return{patient:{findMany:(r={})=>a._.patient.findMany({where:{clinicId:e,...r.where||{}},...r||{}}),findUnique:r=>a._.patient.findFirst({where:{clinicId:e,...r.where||{}},...r||{}}),create:r=>a._.patient.create({data:{...r,clinicId:e}}),update:e=>a._.patient.update({where:{id:e.where.id},data:e.data}),delete:e=>a._.patient.delete({where:{id:e.where.id}})},appointment:{findMany:(r={})=>a._.appointment.findMany({where:{clinicId:e,...r.where||{}},...r||{}}),create:r=>a._.appointment.create({data:{...r,clinicId:e}}),update:e=>a._.appointment.update({where:{id:e.where.id},data:e.data})},service:{findMany:(r={})=>a._.service.findMany({where:{clinicId:e,...r.where||{}},...r||{}}),create:r=>a._.service.create({data:{...r,clinicId:e}})},invoice:{findMany:(r={})=>a._.invoice.findMany({where:{clinicId:e,...r.where||{}},...r||{}}),create:r=>a._.invoice.create({data:{...r,clinicId:e}})},raw:a._}}},34490:(e,r,t)=>{t.d(r,{_:()=>i});var a=t(53524);let i=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,8070,6521,9888,8763],()=>t(79893));module.exports=a})();